{% extends "base.html" %} {%block content %}
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <!--<script type ="text/javascript" src = "{{url_for('static', filename = 'cloudnew.js')}}"></script> -->


  <script type ="text/javascript" src = "{{url_for('static', filename = 'multiline.js')}}"></script>
  <link rel="stylesheet" type="text/css" src = "{{url_for('static', filename = 'multiline.css')}}"></link>
  <script type ="text/javascript" src = "{{url_for('static', filename = 'dc.js')}}"></script>
  <!--<script type ="text/javascript" src = "{{url_for('static', filename = 'd3.layout.cloud.js')}}"></script>-->
  <!--<script type ="text/javascript" src = "{{url_for('static', filename = 'wordCloud.js')}}"></script>-->

  <div class="container">
    <!-- --- DASHBOARD ----------->

    <div class="row">

        <div id="dashboard" >
            <strong>Dashboard</strong>
            <a class="reset" href="javascript:yearlyBubbleChart.filterAll();dc.redrawAll();"
               style="display: none;">reset</a>


      </div>
      </div>
<div class="row">
        <div id="dashboard2">
            <strong>Dashboard 2</strong>
            <a class="reset" href="javascript:gainOrLossChart.filterAll();dc.redrawAll();"
                style="display: none;">reset</a>


        </div>
    </div>
    <!-- --- DASHBOARD2 ----------->
    <div class="row">

    </div>

    <div class="row">
      <!-- ----- GEOLOCATION ---------->
      <!--  <div class="chart-wrapper" id="chart-line1">
            <strong>Timeline</strong>
            <a class="reset" href="javascript:quarterChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
            <div class="clearfix"></div>
        </div>-->
        <div id="us-chart">
            <strong>Tweet Distribution by States (color: total favourite counts)</strong>
            <a class="reset" href="javascript:usChart.filterAll();dc.redrawAll();scalee();" style="display: none;">reset</a>
            <span class="reset" style="display: none;"> | Current filter: <span class="filter"></span></span>
            <div class="clearfix"></div>
        </div>
        <div class="clearfix"></div>
        <div id="industry-chart">
            <strong>By Hashtags</strong> (y: number of retweets, x: total favorite, radius: total favorite )
            <a class="reset" href="javascript:industryChart.filterAll();dc.redrawAll();scalee();" style="display: none;">reset</a>
            <div class="clearfix"></div>
        </div>
    </div>

    <div class="row">
        <div id="monthly-move-chart">
            <strong></strong>
            <span class="reset" style="display: none;">range: <span class="filter"></span></span>
            <a class="reset" href="javascript:moveChart.filterAll();volumeChart.filterAll();dc.redrawAll();scalee();"
               style="display: none;">reset</a>
            <div class="clearfix"></div>
        </div>
    </div>

    <div class="row">
        <div id="monthly-volume-chart">
        </div>
        <p class="muted pull-right" style="margin-right: 15px;">select a time range to zoom in</p>
    </div>

    <div class="row">
        <div id="us-chart"></div>
        <p class="muted pull-right" style="margin-right: 15px;">select a time range to zoom in</p>
    </div>


    <div class="row">
        <div>
            <div class="dc-data-count">
                <span class="filter-count"></span> selected out of <span class="total-count"></span> records | <a
                    href="javascript:dc.filterAll(); dc.renderAll();scalee();">Reset All</a>
            </div>
        </div>
        <table class="table table-hover dc-data-table">
        </table>
    </div>

    <div class="row">
        <div id="dc-time-chart2">
            <strong>Time Chart</strong>
            <span class="reset" style="display: none;">range: <span class="filter"></span></span>
            <a class="reset" href="javascript:timeChart2.filterAll();dc.redrawAll();scalee()"
               style="display: none;">reset</a>

            <div class="clearfix"></div>
        </div>
    </div>


    <div class="row">
        <div id="tweet-distribution">
        </div>
        <p class="muted pull-right" style="margin-right: 15px;">select a time range to zoom in</p>
    </div>



    <div class = "row">
      <div id="day-of-week-chart">
          <strong>Day of Week</strong>
          <a class="reset" href="javascript:dayOfWeekChart.filterAll();dc.redrawAll();scalee()" style="display: none;">reset</a>

          <div class="clearfix"></div>
      </div>

      <div id="sentiment-chart">
          <strong>Overall Sentiment</strong>
          <a class="reset" href="javascript:sentimentChart.filterAll();dc.redrawAll();scalee()" style="display: none;">reset</a>

          <div class="clearfix"></div>
      </div>

      <div id="hour-of-day-chart">
          <strong>Hour of Day</strong>
          <a class="reset" href="javascript:hourOfDayChart.filterAll();dc.redrawAll();scalee()" style="display: none;">reset</a>

          <div class="clearfix"></div>
      </div>

    </div>
    <div class="row">

    <div id="test"></div>
</div>
    <div class="row">
        <div>

          <div id="search"></div>
          <div id="paging">
              Showing <span id="begin"></span>-<span id="end"></span> of <span id="size"></span> <span id="totalsize"></span>
              <input id="last" class="btn" type="Button" value="Last" onclick="javascript:last()" />
              <input id="next" class="btn" type="button" value="Next" onclick="javascript:next()"/>
            </div>
            <div style="clear:both;" class="tweet-data-count">
                <span class="filter-count"></span> selected out of <span class="total-count"></span> records | <a
                    href="javascript:dc.filterAll(); dc.renderAll();">Reset All</a>
            </div>
        </div>
        <table class="table table-hover tweet-data-table">
        </table>
    </div>




  </div> <!-- Container -->


<script>

  /*    var parseDate = d3.timeParse("%Y-%m-%dT%H:%M:%S");

      d3.csv('{{url_for('static', filename = 'multi-line_witbrag.csv')}}', function(error, data) {
      data.forEach(function (d) {
          d.date = parseDate(d.date);
          d.value1 = +d.value1;
          d.value2 = +d.value2;
          d.value3 = +d.value3;
      });

      var chart = makeLineChart(data, 'date', {
          'Negative': {column: 'value1'},
          'Neutral': {column: 'value2'},
          'Positive': {column: 'value3'}
      });
      chart.bind({selector:"#chart-line1",chartSize:{height:452, width:960}, axisLabels: {xAxis:'Dates', yAxis: 'Count'}});
      chart.render();

    }); */

      //   drawWordCloud();

    //var tagslist = dc.wordCloud("#tag-cloud")

          var tweetDistributionChart = dc.barChart('#tweet-distribution');
          var numberFormat = d3.format(".2f");
          var sentimentChart = dc.pieChart('#sentiment-chart');
          var usChart = dc.geoChoroplethChart("#us-chart");
          var industryChart = dc.bubbleChart("#industry-chart");
          var dayOfWeekChart = dc.rowChart('#day-of-week-chart');
          var scale = Math.min(400 * 1.2, 250 * 2.1);
          var hourOfDayChart = dc.barChart('#hour-of-day-chart');
          var heatchart = dc.heatMap("#test");
          var timeChart2 = dc.lineChart("#dc-time-chart2");

          var dateFormatSpecifier = "%Y-%m-%d %H:%M:%S";
          var dateFormat = d3.timeFormat(dateFormatSpecifier);
          var dateFormatParser = d3.timeParse(dateFormatSpecifier);
          var numberFormat = d3.format('.2f');

          var allFeedback="";
          var allWords;
          var wordFrequencies = [];

          var tweetTable = dc.dataTable('.tweet-data-table');
          var data;
          d3.csv('{{url_for('static', filename = 'WITBrag_DC_Dashboard.csv')}}').then(function (csv) {
            csv.forEach(function (d) {
                d.dtg = dateFormatParser(d.date);
                d.hours = d3.timeHour(dateFormatParser(d.date)); //Pre-calculated for better performance
                d.hourNumber = (dateFormatParser(d.date)).getHours();
                d.month = d3.timeMonth(d.dtg);
                d.hash = d.hashtags.toLowerCase();
                d.day = d.dtg.getDay();
                d.words=  d3.set(  d.hash.split(/[\s*\.*\,\;\+?\#\|:\-\/\\\[\]\(\)\{\}$%&0-9*]/)  ).values();
               //build huge string that holds all feedback
               allFeedback =allFeedback + " " + d.hash;
            });

              allWords = d3.set(allFeedback.split(/[\s*\.*\,\;\+?\#\|:\-\/\\\[\]\(\)\{\}$%&0-9*]/)).values();
              allWords.forEach( function(entry){ wordFrequencies.push({key: entry, count: 0 }) }  );

              //going to use this for initial reduce
              var initWordFrequencies = wordFrequencies;

              function getId(array, id) {
                for (var i = 0, len = array.length; i < len; i++) {
                  if (array[i].key === id) {
                  return i ;   //just want the index
                  break;
                  }
                }
                return null; //nothing found
              }

              data = crossfilter(csv);
              var all = data.groupAll();
              var states = data.dimension(function (d) {
                  return d["State"];
              });
              var stateRaisedSum = states.group().reduceCount(function (d) {
                  return d["State"];
              });
              // Dimension by full date
              var dateDimension = data.dimension(function (d) {
                  return d.text;
              });

              var industries = data.dimension(function (d) {
                  return d["hashtags"].toLowerCase();
              });

              var separator = "~";
              var tag_dim = data.dimension(function (d) { return d["hashtags"].toLowerCase() || "" });
              var tag_group = tag_dim.group();
              console.log(tag_group.top(3));
              var frequencyGroup= industries.groupAll().reduce(
                   function (p, v) {
                 	   for (var i in v.words) {
                 	   var j = getId(initWordFrequencies, v.words[i] );
                       p[j].count++;


                                  }
                                 return p;
                        },
                         function (p, v) {
                            for (var i in v.words) {
                 	   var j = getId(initWordFrequencies, v.words[i] );
                       p[j].count--;


                                  }
                                 return p;
                        },
                         function (p,v)  {
                              return   initWordFrequencies  ;
                          }
                     );

            //  var sortByFoo = crossfilter.quicksort.by(function(d) { return d.count; });

              //var authSort = sortByFoo(frequencyGroup,0,frequencyGroup.length);
                //  console.log(authSort);

                //console.log(frequencyGroup.value());


              var hashtagGroup = industries.group().reduceCount(function (d) {
                  return d["hashtags"].toLowerCase();
              });

            //  console.log(hashtagGroup.top(20));

              var statsByIndustries = industries.group().reduce(
                      function (p, v) {
                          p.amountRaised += +v["favorite_count"];
                          p.deals += +v["retweet_count"];
                          //p.polarity += v["polarity"];
                          if (v["polarity"] === "positive") p.pole += 1;
                          else if (v["polarity"] === "negative") p.pole += -1;
                          else p.pole += 0;
                          return p;
                      },
                      function (p, v) {
                          p.amountRaised -= +v["favorite_count"];
                          if (p.amountRaised < 0.001) p.amountRaised = 0; // do some clean up
                          p.deals -= +v["retweet_count"];
                        //  p.polarity -= v["polarity"];
                          if (v["polarity"] === "positive") p.pole -= 1;
                          else if (v["polarity"] === "negative") p.pole -= -1;
                          else p.pole -= 0;
                          return p;
                      },
                      function () {
                          return {amountRaised: 0, deals: 0, polarity: '', pole: 0}
                      }
              );
            //  console.log(statsByIndustries.top(3));
              // define a daily volume Dimension



               var volumeByDay = data.dimension(function(d) {
                 return d.hours;
               });

               // map/reduce to group sum
               var volumeByDayGroup = volumeByDay.group()
                 .reduceCount(function(d) { return d3.timeHour(d.dtg); });

               var volumeByPolarity = data.dimension(function(d) {
                  return d.polarity;
               });

              var sentimentArray = ['neutral', 'negative', 'positive'];

              var sentimentGroup = volumeByDay.group().reduce(
                function(p, v) {
                  p[v.polarity] = (p[v.polarity] || 0) + 1;
                  return p;
                },
                function(p, v) {
                  p[v.polarity] = (p[v.polarity] || 0) - 1;
                  return p;
                },
                function() {
                  return sentimentArray.reduce(function(p, v) {
                    p[v] = 0;
                    return p;
                  }, {});
                });

              function sel_stack(i) {
                return function(d) {
                  return d.value[i];
                };
              }

              var hourOfDay = data.dimension(function (d) {
                return d.hourNumber;
              });

              var hourOfDayGroup = hourOfDay.group();

               var dayOfWeek = data.dimension(function (d) {
                   var name = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                   return d.day + '.' + name[d.day];
               });

               var dayOfWeekGroup = dayOfWeek.group();


              // Create categorical dimension
               var polarity = data.dimension(function (d) {
                   if (d.polarity === "neutral") {
                     return 'Neutral';
                   } else if (d.polarity === "negative") {
                     return 'Negative';
                   } else {
                     return 'Positive';
                   }
               });

               // Produce counts records in the dimension
               var polarityGroup = polarity.group();

               var moveHours = data.dimension(function (d) {
                   return d.hours;
               });

               var volumeByHoursGroup = moveHours.group().reduceCount(function (d) {
                   return d.dtg;
               });

              var  runDim = data.dimension(function(d) {
                var name = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                return [d.hourNumber, name[d.day]];
              });

             var runGroup = runDim.group().reduceCount();

             console.log(runGroup.top(3));

              d3.json('{{url_for('static', filename = 'us-states.json')}}').then(function (statesJson) {
                  usChart.width(990)
                          .height(500)
                          .dimension(states)
                          .group(stateRaisedSum)
                          .colors(d3.scaleQuantize().range(["#E2F2FF", "#C4E4FF", "#9ED2FF", "#81C5FF", "#6BBAFF", "#51AEFF", "#36A2FF", "#1E96FF", "#0089FF", "#0061B5"]))
                          .colorDomain([0, 200])
                          .colorCalculator(function (d) { return d ? usChart.colors()(d) : '#ccc'; })
                          .overlayGeoJson(statesJson.features, "state", function (d) {
                              return d.properties.name;
                          })
                      .projection(d3.geoAlbersUsa())
                      .valueAccessor(function(kv) {
                          //console.log(kv);
                          return kv.value;
                      })
                          .title(function (d) {
                              return "State: " + d.key + "\nTotal tweets: " + numberFormat(d.value ? d.value : 0);
                          });



                  industryChart.width(990)
                          .height(200)
                          .margins({top: 10, right: 50, bottom: 30, left: 60})
                          .dimension(industries)
                          .group(statsByIndustries)
                          //.colors(d3.scaleOrdinal(d3.schemeCategory10))
                          .keyAccessor(function (p) {
                              return p.value.amountRaised;
                          })
                          .valueAccessor(function (p) {
                              return p.value.deals;
                          })
                          .radiusValueAccessor(function (p) {
                              return p.value.amountRaised;
                          })
                          .x(d3.scaleLinear().domain([0, 5000]))
                          .r(d3.scaleLinear().domain([0, 4000]))
                          .colors(d3.schemeRdYlGn[5])
                          //(optional) define color domain to match your data domain if you want to bind data or color
                          .colorDomain([-100, 100])
                      //##### Accessors

                          //Accessor functions are applied to each value returned by the grouping

                          // `.colorAccessor` - the returned value will be passed to the `.colors()` scale to determine a fill color
                          .colorAccessor(function (d) {
                              return d.value.pole;
                          })
                        /*  .colors(d3.scaleOrdinal().domain(["positive", "negative", "neutral"])
                          .range(["#30d34e", "#ef2121", "#605e5e"]))
                          //(optional) define color domain to match your data domain if you want to bind data or color

                      //##### Accessors

                          //Accessor functions are applied to each value returned by the grouping

                          // `.colorAccessor` - the returned value will be passed to the `.colors()` scale to determine a fill color
                          .colorAccessor(function (p) {
                            return p.value.polarity;
                          })*/
                          .minRadiusWithLabel(15)
                          .elasticY(true)
                          .yAxisPadding(100)
                          .elasticX(true)
                          .xAxisPadding(200)
                          .maxBubbleRelativeSize(0.07)
                          .renderHorizontalGridLines(true)
                          .renderVerticalGridLines(true)
                          .renderLabel(true)
                          .renderTitle(true)
                          .title(function (p) {
                              return p.key
                                      + "\n"
                                      + "Favorite Counts " + numberFormat(p.value.amountRaised) + "\n"
                                      + "Retweet Counts: " + numberFormat(p.value.deals);
                          });

                  industryChart.yAxis().tickFormat(function (s) {
                      return s + " Re";
                  });
                  industryChart.xAxis().tickFormat(function (s) {
                      return s;
                  });


                  timeChart2.renderArea(true)
                  .width(990)
                                      .height(250)
                                      //.margins({top: 10, right: 50, bottom: 30, left: 60})
                                      .dimension(volumeByDay)
                                      .group(sentimentGroup, sentimentArray[0], sel_stack(sentimentArray[0]))
                                      //.group(sentimentGroup, sentimentArray[0], sel_stack(sentimentArray[0]))
                                      .transitionDuration(500)
                                      .renderHorizontalGridLines(true)
                                      .legend(dc.legend().x(800).y(10).itemHeight(13).gap(5))
                                      .elasticY(true)
                                      .brushOn(false)
                                      .rangeChart(tweetDistributionChart)
                                      .x(d3.scaleTime().domain([new Date(2017, 7, 12), new Date(2017, 7, 18)])) // scale and domain of the graph
                                      .xAxis();

                                      for (var i = 1; i < sentimentArray.length; i++)
                                        timeChart2.stack(sentimentGroup, sentimentArray[i], sel_stack(sentimentArray[i]));

                  dayOfWeekChart /* dc.rowChart('#day-of-week-chart', 'chartGroup') */
                                .width(180)
                                .height(180)
                                .margins({top: 20, left: 10, right: 10, bottom: 20})
                                .group(dayOfWeekGroup)
                                .dimension(dayOfWeek)
                                // Assign colors to each value in the x scale domain
                                .ordinalColors(['#3182bd', '#6baed6', '#9ecae1', '#c6dbef', '#dadaeb'])
                                .label(function (d) {
                                    return d.key.split('.')[1];
                                })
                                // Title sets the row text
                                .title(function (d) {
                                    return d.value;
                                })
                                .elasticX(true)
                                .xAxis().ticks(4);

                    hourOfDayChart
                        .width(400)
                        .height(250)
                        .x(d3.scaleLinear().domain([0,23]))
                        .brushOn(true)
                        .yAxisLabel("Number of Tweets")
                        .xAxisLabel("Hours")
                        .dimension(hourOfDay)
                        .group(hourOfDayGroup)
                        .on('renderlet', function(chart) {
                            chart.selectAll('rect').on("click", function(d) {
                                console.log("click!", d);
                            });
                        });
                        hourOfDayChart.render();

                /*
                  hourOfDayChart /* dc.rowChart('#day-of-week-chart', 'chartGroup') */
                                /*.width(180)
                                .height(180)
                                .margins({top: 20, left: 10, right: 10, bottom: 20})
                                .group(hourOfDayGroup)
                                .dimension(hourOfDay)
                                // Assign colors to each value in the x scale domain
                                .ordinalColors(['#3182bd', '#6baed6', '#9ecae1', '#c6dbef', '#dadaeb'])
                                .label(function (d) {
                                    return d.key;
                                })
                                // Title sets the row text
                                .title(function (d) {
                                    return d.value;
                                })
                                .elasticX(true)
                                .xAxis().ticks(4);
*/
                  sentimentChart /* dc.pieChart('#gain-loss-chart', 'chartGroup') */
                                // (_optional_) define chart width, `default = 200`
                                    .width(180)
                                // (optional) define chart height, `default = 200`
                                    .height(180)
                                // Define pie radius
                                    .radius(80)
                                // Set dimension
                                    .dimension(polarity)
                                // Set group
                                    .group(polarityGroup)
                                // (_optional_) by default pie chart will use `group.key` as its label but you can overwrite it with a closure.
                                    .label(function (d) {
                                        if (sentimentChart.hasFilter() && !sentimentChart.hasFilter(d.key)) {
                                            return d.key + '(0%)';
                                        }
                                        var label = d.key;
                                        if (all.value()) {
                                            label += '(' + Math.floor(d.value / all.value() * 100) + '%)';
                                        }
                                        return label;
                                    })

                     tweetDistributionChart.width(990) /* dc.barChart('#monthly-volume-chart', 'chartGroup'); */
                                        .height(70)
                                        .margins({top: 0, right: 50, bottom: 20, left: 40})
                                        //.yAxis().tickValues([])

                                        //.margins({left: 10, top: 10, right: 30, bottom: 20})
                                        .dimension(moveHours)
                                        .group(volumeByHoursGroup)
                                        .centerBar(true)
                                        .gap(1)

                                        .x(d3.scaleTime().domain([new Date(2017, 7, 12), new Date(2017, 7, 18)]))
                                        .round(d3.timeHour.round)
                                        .alwaysUseRounding(true)
                                        .xUnits(d3.timeHour);

                    tweetTable /* dc.dataTable('.dc-data-table', 'chartGroup') */
                        .dimension(dateDimension)
                        // Data table does not use crossfilter group but rather a closure
                        // as a grouping function
                        .group(function (d) {
                            var format = d3.format('02d');
                            return d.dtg.getFullYear() + '/' + format((d.dtg.getMonth() + 1));
                        })

                        // (_optional_) max number of records to be shown, `default = 25`
                        .size(Infinity)
                        // There are several ways to specify the columns; see the data-table documentation.
                        // This code demonstrates generating the column header automatically based on the columns.
                        .columns([
                            'date',
                            'text',
                            'favorite_count',
                            'polarity'
                        ])
                        .on('preRender', update_offset)
                                  .on('preRedraw', update_offset)
                                  .on('pretransition', display)
                        // (_optional_) sort using the given field, `default = function(d){return d;}`
                        .sortBy(function (d) {
                            return d.favorite_count;
                        })
                        // (_optional_) sort order, `default = d3.ascending`
                        .order(d3.descending)
                        // (_optional_) custom renderlet to post-process chart using [D3](http://d3js.org)
                        .on('renderlet', function (table) {
                            table.selectAll('.dc-table-group').classed('info', true);
                        });

                        var chart = dc.textFilterWidget("#search")
                          .dimension(dateDimension);

              heatchart
                  .width(45 * 20 + 80)
                  .height(45 * 5 + 40)
                  .dimension(runDim)
                  .group(runGroup)
                  .keyAccessor(function(d) { return d.key[0] + ' hr'; })
                  .valueAccessor(function(d) { return d.key[1]; })
                  .colorAccessor(function(d) { return +d.value; })
                  .legend(dc.legend().x(0).y(0).itemHeight(13).gap(5))
                  .title(function(d) {
                      return "Day:   " + d.key[0] + "\n" +
                             "Hour:  " + d.key[1] + "\n" +
                             "Count: " + (299000 + d.value)})
                  .colors(["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"])
                  .calculateColorDomain();

                        dc.renderAll();

                  scalee();
                  // Change the size of the US chart by 0.7

              });
          });
          var ofs = 0, pag = 17;
                      function update_offset() {
                var totFilteredRecs = data.groupAll().value();
                var end = ofs + pag > totFilteredRecs ? totFilteredRecs : ofs + pag;
                ofs = ofs >= totFilteredRecs ? Math.floor((totFilteredRecs - 1) / pag) * pag : ofs;
                ofs = ofs < 0 ? 0 : ofs;
                tweetTable.beginSlice(ofs);
                tweetTable.endSlice(ofs+pag);
            }
            function display() {
                var totFilteredRecs = data.groupAll().value();
                var end = ofs + pag > totFilteredRecs ? totFilteredRecs : ofs + pag;
                d3.select('#begin')
                    .text(end === 0? ofs : ofs + 1);
                d3.select('#end')
                    .text(end);
                d3.select('#last')
                    .attr('disabled', ofs-pag<0 ? 'true' : null);
                d3.select('#next')
                    .attr('disabled', ofs+pag>=totFilteredRecs ? 'true' : null);
                d3.select('#size').text(totFilteredRecs);
                if(totFilteredRecs != data.size()){
                  d3.select('#totalsize').text("(filtered Total: " + data.size() + " )");
                }else{
                  d3.select('#totalsize').text('');
                }
            }
                function next() {
                    ofs += pag;
                    update_offset();
                    tweetTable.redraw();
                }
                function last() {
                    ofs -= pag;
                    update_offset();
                    tweetTable.redraw();
                }

          function scalee() {
            usChart.selectAll('g.state').each(function (d) {
                d3.select(this).attr('transform', 'scale(0.7)')
            })
          }
          function dashboard(id, fData){
              var barColor = 'steelblue';
              function segColor(c){ return {negative:"#807dba", neutral:"#e08214",positive:"#41ab5d"}[c]; }

              // compute total for each keyword.
              fData.forEach(function(d){d.total=d.freq.negative+d.freq.neutral+d.freq.positive;});

              // function to handle histogram.
              function histoGram(fD){
                  var hG={},    hGDim = {t: 70, r: 0, b: 70, l: 0};
                  hGDim.w = 500 - hGDim.l - hGDim.r,
                  hGDim.h = 300 - hGDim.t - hGDim.b;

                  //create svg for histogram.
                  var hGsvg = d3.select(id).append("svg")
                      .attr("width", hGDim.w + hGDim.l + hGDim.r)
                      .attr("height", hGDim.h + hGDim.t + hGDim.b).append("g")
                      .attr("transform", "translate(" + hGDim.l + "," + hGDim.t + ")")


                  // create function for x-axis mapping. //Scale ordinal is not supported in V5
                  var x = d3.scaleBand().rangeRound([0, hGDim.w], 0.1)
                          .domain(fD.map(function(d) { return d[0]; }));

                  // Add x-axis to the histogram svg.
                  hGsvg.append("g").attr("class", "x axis")
                      .attr("transform", "translate(0," + hGDim.h + ")")
                      //.call(d3.svg.axis().scale(x).orient("bottom"))
                      .call(d3.axisBottom(x))
                      .selectAll("text")
                      .attr("y", 0)
                      .attr("x", 9)
                      .attr("dy", ".35em")
                      .attr("transform", "rotate(90)")
                      .style("text-anchor", "start");

                  // Create function for y-axis map.
                  var y = d3.scaleLinear().range([hGDim.h, 0])
                          .domain([0, d3.max(fD, function(d) { return d[1]; })]);

                  // Create bars for histogram to contain rectangles and freq labels.
                  var bars = hGsvg.selectAll(".bar").data(fD).enter()
                          .append("g").attr("class", "bar");

                  //create the rectangles.
                  bars.append("rect")
                      .attr("x", function(d) { return x(d[0]); })
                      .attr("y", function(d) { return y(d[1]); })
                      .attr("width", x.bandwidth())
                      .attr("height", function(d) { return hGDim.h - y(d[1]); })
                      .attr('fill',barColor)
                      .on("mouseover",mouseover)// mouseover is defined below.
                      .on("mouseout",mouseout);// mouseout is defined below.

                  //Create the frequency labels above the rectangles.
                  bars.append("text").text(function(d){ return d3.format(",")(d[1])})
                      .attr("x", function(d) { return x(d[0])+x.bandwidth()/2; })
                      .attr("y", function(d) { return y(d[1])-5; })
                      .attr("text-anchor", "middle");

                  function mouseover(d){  // utility function to be called on mouseover.
                      // filter for selected keyword.
                      var st = fData.filter(function(s){ return s.keyword == d[0];})[0],
                          nD = d3.keys(st.freq).map(function(s){ return {type:s, freq:st.freq[s]};});

                      // call update functions of pie-chart and legend.
                      pC.update(nD);
                      leg.update(nD);
                  }

                  function mouseout(d){    // utility function to be called on mouseout.
                      // reset the pie-chart and legend.
                      pC.update(tF);
                      leg.update(tF);
                  }

                  // create function to update the bars. This will be used by pie-chart.
                  hG.update = function(nD, color){
                      // update the domain of the y-axis map to reflect change in frequencies.
                      y.domain([0, d3.max(nD, function(d) { return d[1]; })]);

                      // Attach the new data to the bars.
                      var bars = hGsvg.selectAll(".bar").data(nD);

                      // transition the height and color of rectangles.
                      bars.select("rect").transition().duration(500)
                          .attr("y", function(d) {return y(d[1]); })
                          .attr("height", function(d) { return hGDim.h - y(d[1]); })
                          .attr("fill", color);

                      // transition the frequency labels location and change value.
                      bars.select("text").transition().duration(500)
                          .text(function(d){ return d3.format(",")(d[1])})
                          .attr("y", function(d) {return y(d[1])-5; });
                  }
                  return hG;
              }

              // function to handle pieChart.
              function pieChart(pD){
                  var pC ={},    pieDim ={w:150, h: 150};
                  pieDim.r = Math.min(pieDim.w, pieDim.h) / 2;

                  // create svg for pie chart.
                  var piesvg = d3.select(id).append("svg")
                      .attr("width", pieDim.w).attr("height", pieDim.h).append("g")
                      .attr("transform", "translate("+pieDim.w/2+","+pieDim.h/2+")");

                  // create function to draw the arcs of the pie slices.
                  var arc = d3.arc().outerRadius(pieDim.r - 10).innerRadius(0);

                  // create a function to compute the pie slice angles.
                  var pie = d3.pie().sort(null).value(function(d) { return d.freq; });

                  // Draw the pie slices.
                  piesvg.selectAll("path").data(pie(pD)).enter().append("path").attr("d", arc)
                      .each(function(d) { this._current = d; })
                      .style("fill", function(d) { return segColor(d.data.type); })
                      .on("mouseover",mouseover).on("mouseout",mouseout);

                  // create function to update pie-chart. This will be used by histogram.
                  pC.update = function(nD){
                      piesvg.selectAll("path").data(pie(nD)).transition().duration(500)
                          .attrTween("d", arcTween);
                  }
                  // Utility function to be called on mouseover a pie slice.
                  function mouseover(d){
                      // call the update function of histogram with new data.
                      hG.update(fData.map(function(v){
                          return [v.keyword,v.freq[d.data.type]];}),segColor(d.data.type));
                  }
                  //Utility function to be called on mouseout a pie slice.
                  function mouseout(d){
                      // call the update function of histogram with all data.
                      hG.update(fData.map(function(v){
                          return [v.keyword,v.total];}), barColor);
                  }
                  // Animating the pie-slice requiring a custom function which specifies
                  // how the intermediate paths should be drawn.
                  function arcTween(a) {
                      var i = d3.interpolate(this._current, a);
                      this._current = i(0);
                      return function(t) { return arc(i(t));    };
                  }
                  return pC;
              }

              // function to handle legend.
              function legend(lD){
                  var leg = {};

                  // create table for legend.
                  var legend = d3.select(id).append("table").attr('class','legend');

                  // create one row per segment.
                  var tr = legend.append("tbody").selectAll("tr").data(lD).enter().append("tr");

                  // create the first column for each segment.
                  tr.append("td").append("svg").attr("width", '8').attr("height", '8').append("rect")
                      .attr("width", '8').attr("height", '8')
          			.attr("fill",function(d){ return segColor(d.type); });

                  // create the second column for each segment.
                  tr.append("td").text(function(d){ return d.type;});

                  // create the third column for each segment.
                  tr.append("td").attr("class",'legendFreq')
                      .text(function(d){ return d3.format(",")(d.freq);});

                  // create the fourth column for each segment.
                  tr.append("td").attr("class",'legendPerc')
                      .text(function(d){ return getLegend(d,lD);});

                  // Utility function to be used to update the legend.
                  leg.update = function(nD){
                      // update the data attached to the row elements.
                      var l = legend.select("tbody").selectAll("tr").data(nD);

                      // update the frequencies.
                      l.select(".legendFreq").text(function(d){ return d3.format(",")(d.freq);});

                      // update the percentage column.
                      l.select(".legendPerc").text(function(d){ return getLegend(d,nD);});
                  }

                  function getLegend(d,aD){ // Utility function to compute percentage.
                      return d3.format("%")(d.freq/d3.sum(aD.map(function(v){ return v.freq; })));
                  }

                  return leg;
              }

              // calculate total frequency by segment for all keyword.
              var tF = ['positive','neutral','negative'].map(function(d){
                  return {type:d, freq: d3.sum(fData.map(function(t){ return t.freq[d];}))};
              });

              // calculate total frequency by keyword for all segment.
              var sF = fData.map(function(d){return [d.keyword,d.total];});

              var hG = histoGram(sF), // create the histogram.
                  pC = pieChart(tF), // create the pie-chart.
                  leg= legend(tF);  // create the legend.
          }



          var freqData=[
            {"freq": {"positive": 0.0, "neutral": 0.0, "negative": 2.0}, "keyword": "chocolatelegoscrum"}, {"freq": {"positive": 0.0, "neutral": 3.0, "negative": 6.0}, "keyword": "business"}, {"freq": {"positive": 6.0, "neutral": 3.0, "negative": 2.0}, "keyword": "witbrag"}, {"freq": {"positive": 0.0, "neutral": 0.0, "negative": 8.0}, "keyword": "choicemalewebstar"}, {"freq": {"positive": 0.0, "neutral": 1.0, "negative": 8.0}, "keyword": "unitetheright"}, {"freq": {"positive": 1.0, "neutral": 6.0, "negative": 6.0}, "keyword": "africa"}, {"freq": {"positive": 1.0, "neutral": 4.0, "negative": 2.0}, "keyword": "devops"}, {"freq": {"positive": 21.0, "neutral": 7.0, "negative": 1.0}, "keyword": "stem"}, {"freq": {"positive": 2.0, "neutral": 1.0, "negative": 1.0}, "keyword": "netflix"}, {"freq": {"positive": 0.0, "neutral": 3.0, "negative": 3.0}, "keyword": "entrepreneur"}, {"freq": {"positive": 30.0, "neutral": 9.0, "negative": 1.0}, "keyword": "wit"}, {"freq": {"positive": 85.0, "neutral": 48.0, "negative": 15.0}, "keyword": "womenintech"}, {"freq": {"positive": 5.0, "neutral": 14.0, "negative": 2.0}, "keyword": "charlottesville"}, {"freq": {"positive": 1668.0, "neutral": 1136.0, "negative": 243.0}, "keyword": "witbragday"}, {"freq": {"positive": 3.0, "neutral": 1.0, "negative": 1.0}, "keyword": "infosec"}, {"freq": {"positive": 0.0, "neutral": 20.0, "negative": 8.0}, "keyword": "gyan_ganga"}, {"freq": {"positive": 2.0, "neutral": 5.0, "negative": 3.0}, "keyword": "technology"}, {"freq": {"positive": 26.0, "neutral": 7.0, "negative": 9.0}, "keyword": "tech"}, {"freq": {"positive": 1.0, "neutral": 3.0, "negative": 1.0}, "keyword": "mitbragday"}, {"freq": {"positive": 16.0, "neutral": 4.0, "negative": 1.0}, "keyword": "women"}];

          var freqDataKeywords=[{"freq": {"positive": 30.0, "neutral": 29.0, "negative": 16.0}, "keyword": "every"}, {"freq": {"positive": 8.0, "neutral": 0.0, "negative": 18.0}, "keyword": "little"}, {"freq": {"positive": 89.0, "neutral": 80.0, "negative": 20.0}, "keyword": "code"}, {"freq": {"positive": 2.0, "neutral": 24.0, "negative": 16.0}, "keyword": "god"}, {"freq": {"positive": 734.0, "neutral": 393.0, "negative": 164.0}, "keyword": "i"}, {"freq": {"positive": 44.0, "neutral": 27.0, "negative": 16.0}, "keyword": "got"}, {"freq": {"positive": 11.0, "neutral": 0.0, "negative": 19.0}, "keyword": "hard"}, {"freq": {"positive": 55.0, "neutral": 40.0, "negative": 19.0}, "keyword": "years"}, {"freq": {"positive": 19.0, "neutral": 0.0, "negative": 32.0}, "keyword": "late"}, {"freq": {"positive": 105.0, "neutral": 55.0, "negative": 15.0}, "keyword": "this"}, {"freq": {"positive": 32.0, "neutral": 29.0, "negative": 17.0}, "keyword": "3"}, {"freq": {"positive": 44.0, "neutral": 44.0, "negative": 21.0}, "keyword": "2"}, {"freq": {"positive": 272.0, "neutral": 124.0, "negative": 27.0}, "keyword": "tech"}, {"freq": {"positive": 59.0, "neutral": 33.0, "negative": 15.0}, "keyword": "know"}, {"freq": {"positive": 76.0, "neutral": 30.0, "negative": 16.0}, "keyword": "team"}, {"freq": {"positive": 193.0, "neutral": 109.0, "negative": 28.0}, "keyword": "amp"}, {"freq": {"positive": 140.0, "neutral": 55.0, "negative": 29.0}, "keyword": "i\'m"}, {"freq": {"positive": 115.0, "neutral": 43.0, "negative": 17.0}, "keyword": "one"}, {"freq": {"positive": 119.0, "neutral": 26.0, "negative": 15.0}, "keyword": "work"}, {"freq": {"positive": 310.0, "neutral": 112.0, "negative": 27.0}, "keyword": "women"}]

          dashboard('#dashboard',freqData);

          dashboard('#dashboard2',freqDataKeywords);


        </script>


{% endblock %}
